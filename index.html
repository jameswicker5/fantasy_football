<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>NFL Weekly Picks</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: system-ui, sans-serif; 
      margin: 0; 
      padding: 2rem; 
      max-width: 1200px; 
      margin: 0 auto;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    
    .container {
      background: white;
      border-radius: 20px;
      padding: 2rem;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    }
    
    header { 
      text-align: center;
      margin-bottom: 2rem; 
      border-bottom: 2px solid #f0f0f0;
      padding-bottom: 1rem;
    }
    
    h1 { 
      color: #2d3748; 
      font-size: 2.5rem; 
      margin: 0;
      background: linear-gradient(45deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .section { 
      margin-bottom: 2rem; 
      background: #f8fafc;
      border-radius: 15px;
      padding: 1.5rem;
    }
    
    .auth-section {
      text-align: center;
      background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
    }
    
    .auth-form {
      display: inline-flex;
      flex-direction: column;
      gap: 1rem;
      align-items: center;
    }
    
    .user-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    label { 
      display: block; 
      margin-bottom: 0.5rem; 
      font-weight: 600;
      color: #2d3748;
    }
    
    select, input, button { 
      padding: 0.75rem; 
      margin: 0.25rem 0; 
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 1rem;
      transition: all 0.3s ease;
    }
    
    select:focus, input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: transform 0.2s ease;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }
    
    button:disabled {
      background: #cbd5e0;
      cursor: not-allowed;
      transform: none;
    }
    
    .week-controls { 
      display: grid; 
      grid-template-columns: 1fr 1fr; 
      gap: 1rem; 
      margin-bottom: 1.5rem;
    }
    
    .picks-grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
      gap: 1rem; 
      margin-bottom: 1.5rem;
    }
    
    .pick-slot {
      background: white;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 1rem;
      transition: all 0.3s ease;
    }
    
    .pick-slot:hover {
      border-color: #667eea;
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.1);
    }
    
    .pick-slot select {
      width: 100%;
      margin: 0;
    }
    
    .position-label {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
    }
    
    .submit-section {
      text-align: center;
    }
    
    .submit-btn {
      padding: 1rem 2rem;
      font-size: 1.1rem;
      min-width: 200px;
    }
    
    .status {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 10px;
      font-weight: 600;
    }
    
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .status.loading {
      background: #cce7ff;
      color: #004085;
      border: 1px solid #b3d7ff;
    }
    
    .leaderboard-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .leaderboard-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      margin-bottom: 0.5rem;
      background: white;
      border-radius: 10px;
      border: 1px solid #e2e8f0;
    }
    
    .leaderboard-item:nth-child(1) { background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); }
    .leaderboard-item:nth-child(2) { background: linear-gradient(135deg, #c0c0c0 0%, #e2e8f0 100%); }
    .leaderboard-item:nth-child(3) { background: linear-gradient(135deg, #cd7f32 0%, #d69e2e 100%); }
    
    .muted { 
      color: #718096; 
      font-size: 0.9rem; 
      font-style: italic;
      text-align: center;
      margin: 1rem 0;
    }
    
    @media (max-width: 768px) {
      body { padding: 1rem; }
      .container { padding: 1rem; }
      h1 { font-size: 2rem; }
      .week-controls { grid-template-columns: 1fr; }
      .picks-grid { grid-template-columns: 1fr; }
      .user-info { justify-content: center; text-align: center; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üèà NFL Weekly Picks</h1>
      <div id="auth"></div>
    </header>

    <div id="main-content" style="display: none;">
      <section class="section">
        <h2>üìã Make Your Picks</h2>
        <div class="week-controls">
          <div>
            <label>Season</label>
            <input id="season" type="number" value="2025" min="2020" max="2030" />
          </div>
          <div>
            <label>Week</label>
            <input id="week" type="number" value="1" min="1" max="18" />
          </div>
        </div>

        <p class="muted">Select your starting lineup for the week. Each position must be filled!</p>

        <div id="pick-form" class="picks-grid">
          <!-- Pick slots will be generated here -->
        </div>
        
        <div class="submit-section">
          <button id="submit" class="submit-btn">Submit My Picks</button>
          <div id="submit-status"></div>
        </div>
      </section>

      <section class="section">
        <h2>üèÜ Leaderboard</h2>
        <div id="leaderboard"></div>
        <p class="muted">Rankings based on total picks submitted this season.</p>
      </section>
    </div>
  </div>

<script type="module">
  // Import Supabase
import { createClient } from '@supabase/supabase-js'
const SUPABASE_URL = 'https://jbjbhlqskvqqlpovmxah.supabase.co'
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpiamJobHFza3ZxcWxwb3ZteGFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4NDc0ODMsImV4cCI6MjA3MDQyMzQ4M30.wO91VmSnQZV4V_A5WN0qfNr8-7qEwifCZIK4n81MH0A'

  // Initialize Supabase client
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
const slots = [
  { key: 'QB', label: 'Quarterback', count: 1 },
  { key: 'RB1', label: 'Running Back #1', count: 1 },
  { key: 'RB2', label: 'Running Back #2', count: 1 },
  { key: 'WR1', label: 'Wide Receiver #1', count: 1 },
  { key: 'WR2', label: 'Wide Receiver #2', count: 1 },
  { key: 'TE', label: 'Tight End', count: 1 },
  { key: 'FLEX', label: 'Flex (RB/WR/TE)', count: 1 },
  { key: 'K', label: 'Kicker', count: 1 },
  { key: 'DEF', label: 'Defense/ST', count: 1 }
]

const flexPositions = new Set(['RB', 'WR', 'TE'])

const authEl = document.getElementById('auth')
const mainContentEl = document.getElementById('main-content')
const formEl = document.getElementById('pick-form')
const submitBtn = document.getElementById('submit')
const submitStatus = document.getElementById('submit-status')
const seasonEl = document.getElementById('season')
const weekEl = document.getElementById('week')
const leaderboardEl = document.getElementById('leaderboard')

let currentUser = null
let playersCache = {}

// Initialize the app
await initializeApp()

async function initializeApp() {
  try {
    // Handle URL hash for authentication (magic link redirect)
    if (window.location.hash) {
      const hashParams = new URLSearchParams(window.location.hash.substr(1))
      if (hashParams.get('type') === 'email') {
        authEl.innerHTML = '<div class="status loading">Completing sign-in...</div>'
        
        // Let Supabase handle the auth
        const { data, error } = await supabase.auth.getSession()
        
        if (error) {
          console.error('Auth error:', error)
          authEl.innerHTML = `<div class="status error">Sign-in error: ${error.message}</div>`
          // Clear the hash and reload
          setTimeout(() => {
            window.location.hash = ''
            window.location.reload()
          }, 3000)
        } else if (data.session) {
          // Clear the hash
          window.history.replaceState(null, null, window.location.pathname)
          currentUser = data.session.user
        }
      }
    }
    
    await refreshAuthUI()
  } catch (error) {
    console.error('Initialization error:', error)
    authEl.innerHTML = '<div class="status error">Error loading app. Please refresh the page.</div>'
  }
}

// Helper to get user handle
async function getHandle(userId) {
  try {
    const { data, error } = await supabase
      .from('profiles')
      .select('handle')
      .eq('user_id', userId)
      .maybeSingle()
    
    if (error) console.error('Error fetching handle:', error)
    return data?.handle || 'Anonymous Player'
  } catch (error) {
    console.error('Error in getHandle:', error)
    return 'Anonymous Player'
  }
}

// Listen for auth state changes
supabase.auth.onAuthStateChange(async (event, session) => {
  console.log('Auth state changed:', event, session?.user?.email)
  
  if (event === 'SIGNED_IN') {
    currentUser = session?.user || null
    await refreshAuthUI()
  } else if (event === 'SIGNED_OUT') {
    currentUser = null
    await refreshAuthUI()
  }
})

// Auth UI Management
async function refreshAuthUI() {
  try {
    // Get current session if we don't have currentUser set
    if (!currentUser) {
      const { data } = await supabase.auth.getUser()
      currentUser = data.user
    }
    
    if (!currentUser) {
      authEl.innerHTML = `
        <div class="auth-section">
          <div class="auth-form">
            <input id="email" type="email" placeholder="Enter your email address" style="min-width: 280px;" />
            <button id="signin" type="button">Send Magic Link</button>
            <p class="muted">We'll send you a secure sign-in link via email</p>
          </div>
        </div>
      `
      
      document.getElementById('signin').onclick = async () => {
        const email = document.getElementById('email').value.trim()
        if (!email) {
          alert('Please enter an email address')
          return
        }
        
        const button = document.getElementById('signin')
        button.disabled = true
        button.textContent = 'Sending...'
        
        try {
          // Get the current URL without any hash
          const redirectUrl = window.location.origin + window.location.pathname
          
          const { error } = await supabase.auth.signInWithOtp({ 
            email,
            options: {
              emailRedirectTo: redirectUrl
            }
          })
          
          if (error) {
            throw error
          }
          
          alert('Check your email for the sign-in link!')
          button.textContent = 'Link Sent!'
          
        } catch (error) {
          alert('Error: ' + error.message)
          button.disabled = false
          button.textContent = 'Send Magic Link'
        }
      }
      
      mainContentEl.style.display = 'none'
    } else {
      const handle = await getHandle(currentUser.id)
      authEl.innerHTML = `
        <div class="user-info">
          <span style="font-weight: 600; color: #2d3748;">
            Welcome, ${handle}! üëã
          </span>
          <button id="signout" type="button">Sign Out</button>
        </div>
      `
      
      document.getElementById('signout').onclick = async () => {
        await supabase.auth.signOut()
      }
      
      mainContentEl.style.display = 'block'
      await buildForm()
      await loadLeaderboard()
    }
  } catch (error) {
    console.error('Error in refreshAuthUI:', error)
    authEl.innerHTML = '<p class="error">Error loading authentication. Please refresh the page.</p>'
  }
}

// Load players by position
async function loadPlayersByPosition(position) {
  try {
    if (playersCache[position]) {
      return playersCache[position]
    }
    
    if (position === 'DEF') {
      const { data, error } = await supabase
        .from('defenses')
        .select('*')
        .order('def_id')
      
      if (error) throw error
      
      const players = data.map(d => ({
        id: d.def_id,
        label: d.display_name,
        pos: 'DEF'
      }))
      
      playersCache[position] = players
      return players
    }
    
    if (position === 'FLEX') {
      const { data, error } = await supabase
        .from('players')
        .select('gsis_id, display_name, team, position')
        .in('position', ['RB', 'WR', 'TE'])
        .order('position')
        .order('team')
        .order('display_name')
      
      if (error) throw error
      
      const players = data.map(p => ({
        id: p.gsis_id,
        label: `${p.display_name} (${p.team} ${p.position})`,
        pos: p.position
      }))
      
      playersCache[position] = players
      return players
    }
    
    // Regular position
    const { data, error } = await supabase
      .from('players')
      .select('gsis_id, display_name, team, position')
      .eq('position', position)
      .order('team')
      .order('display_name')
    
    if (error) throw error
    
    const players = data.map(p => ({
      id: p.gsis_id,
      label: `${p.display_name} (${p.team})`,
      pos: p.position
    }))
    
    playersCache[position] = players
    return players
  } catch (error) {
    console.error(`Error loading players for position ${position}:`, error)
    return []
  }
}

// Build the pick form
async function buildForm() {
  try {
    formEl.innerHTML = '<div class="loading">Loading players...</div>'
    
    const slotElements = []
    
    for (const slot of slots) {
      const position = slot.key === 'DEF' ? 'DEF' : 
                     slot.key === 'FLEX' ? 'FLEX' : 
                     slot.key.replace(/\d/, '')
      
      const players = await loadPlayersByPosition(position)
      
      const select = document.createElement('select')
      select.id = `slot-${slot.key}`
      select.required = true
      
      // Add default option
      const defaultOption = document.createElement('option')
      defaultOption.value = ''
      defaultOption.textContent = `-- Select ${slot.label} --`
      select.appendChild(defaultOption)
      
      // Add player options
      players.forEach(player => {
        const option = document.createElement('option')
        option.value = player.id
        option.textContent = player.label
        select.appendChild(option)
      })
      
      const slotDiv = document.createElement('div')
      slotDiv.className = 'pick-slot'
      slotDiv.innerHTML = `
        <label class="position-label">${slot.label}</label>
      `
      slotDiv.appendChild(select)
      
      slotElements.push(slotDiv)
    }
    
    formEl.innerHTML = ''
    slotElements.forEach(el => formEl.appendChild(el))
    
  } catch (error) {
    console.error('Error building form:', error)
    formEl.innerHTML = '<div class="error">Error loading form. Please refresh the page.</div>'
  }
}

// Submit picks
async function ensureProfile(userId) {
  const { data: p, error: pe } = await supabase
    .from('profiles')
    .select('user_id')
    .eq('user_id', userId)
    .maybeSingle()
  if (pe) console.warn('profiles select error:', pe)
  if (!p) {
    const { error: pi } = await supabase.from('profiles').insert({ user_id: userId })
    if (pi) console.warn('profiles insert error:', pi)
  }
}

submitBtn.onclick = async () => {
  if (!currentUser) { 
    alert('Please sign in first'); 
    return 
  }

  try {
    submitBtn.disabled = true
    submitStatus.innerHTML = '<div class="status loading">Submitting your picks...</div>'

    const season = Number(seasonEl.value)
    const week = Number(weekEl.value)
    if (!season || !week) throw new Error('Please enter valid season and week')

    const picks = []
    const used = new Set()
    for (const { key, label } of slots) {
      const val = (document.getElementById(`slot-${key}`)?.value || '').trim()
      if (!val) throw new Error(`Please select ${label}`)
      
      // Enhanced duplicate check
      if (key !== 'FLEX') {
        if (used.has(val)) throw new Error(`Duplicate player in non-FLEX slot: ${label}`)
        used.add(val)
      }
      
      picks.push({
        user_id: currentUser.id,
        season,
        week,
        slot: key,
        gsis_id: key === 'DEF' ? null : val,
        def_id: key === 'DEF' ? val : null
      })
    }

    await ensureProfile(currentUser.id)

    console.log('Submitting picks:', picks)  // Detailed logging

    const { data, error } = await supabase
      .from('picks')
      .insert(picks)
      .select()

    if (error) {
      console.error('Detailed picks insert error:', {
        message: error.message,
        details: error.details,
        code: error.code
      })
      submitStatus.innerHTML = `<div class="status error">‚ùå ${error.message} ${error.details || ''}</div>`
      return
    }

    submitStatus.innerHTML = '<div class="status success">‚úÖ Picks submitted!</div>'
    await loadLeaderboard()
  } catch (e) {
    console.error('Comprehensive submit error:', e)
    submitStatus.innerHTML = `<div class="status error">‚ùå ${e.message}</div>`
  } finally {
    submitBtn.disabled = false
  }
}

// Load leaderboard
async function loadLeaderboard() {
  try {
    const season = Number(seasonEl.value)
    
    const { data, error } = await supabase
      .from('picks')
      .select('user_id, season')
      .eq('season', season)
    
    if (error) throw error
    
    // Count picks per user
    const userCounts = {}
    data.forEach(pick => {
      userCounts[pick.user_id] = (userCounts[pick.user_id] || 0) + 1
    })
    
    // Sort by pick count
    const sortedUsers = Object.entries(userCounts)
      .sort(([,a], [,b]) => b - a)
    
    if (sortedUsers.length === 0) {
      leaderboardEl.innerHTML = '<p class="muted">No picks submitted yet for this season.</p>'
      return
    }
    
    // Get handles for users (simplified for demo)
    const leaderboardItems = await Promise.all(
      sortedUsers.map(async ([userId, count], index) => {
        const handle = await getHandle(userId)
        const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}.`
        
        return `
          <div class="leaderboard-item">
            <span>${medal} ${handle}</span>
            <span><strong>${count} picks</strong></span>
          </div>
        `
      })
    )
    
    leaderboardEl.innerHTML = `<div class="leaderboard-list">${leaderboardItems.join('')}</div>`
    
  } catch (error) {
    console.error('Error loading leaderboard:', error)
    leaderboardEl.innerHTML = '<p class="error">Error loading leaderboard</p>'
  }
}

// Season/Week change handlers
seasonEl.addEventListener('change', loadLeaderboard)
weekEl.addEventListener('change', () => {
  // Could load existing picks for the week here
  console.log('Week changed to:', weekEl.value)
})

</script>
</body>
</html>

