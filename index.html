<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Fantasy Football Frenzy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 2rem;
      max-width: 1200px;
      margin: 0 auto;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container { background: white; border-radius: 20px; padding: 2rem; box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
    header { text-align: center; margin-bottom: 2rem; border-bottom: 2px solid #f0f0f0; padding-bottom: 1rem; }
    h1 { color: #2d3748; font-size: 2.5rem; margin: 0; background: linear-gradient(45deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .section { margin-bottom: 2rem; background: #f8fafc; border-radius: 15px; padding: 1.5rem; }
    .auth-section { text-align: center; background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); }
    .auth-form { display: inline-flex; flex-direction: column; gap: 1rem; align-items: center; }
    .user-info { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
    label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2d3748; }
    select, input, button { padding: 0.75rem; margin: 0.25rem 0; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 1rem; transition: all 0.3s ease; }
    select:focus, input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
    button { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; cursor: pointer; font-weight: 600; transition: transform 0.2s ease; }
    button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3); }
    button:disabled { background: #cbd5e0; cursor: not-allowed; transform: none; }
    .week-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem; }
    .picks-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
    .pick-slot { background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 1rem; transition: all 0.3s ease; }
    .pick-slot:hover { border-color: #667eea; box-shadow: 0 5px 15px rgba(102, 126, 234, 0.1); }
    .pick-slot select { width: 100%; margin: 0; }
    .position-label { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 1.1rem; margin-bottom: 0.5rem; }
    .submit-section { text-align: center; }
    .submit-btn { padding: 1rem 2rem; font-size: 1.1rem; min-width: 200px; }
    .status { margin-top: 1rem; padding: 1rem; border-radius: 10px; font-weight: 600; }
    .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .status.loading { background: #cce7ff; color: #004085; border: 1px solid #b3d7ff; }
    .leaderboard-list { list-style: none; padding: 0; margin: 0; }
    .leaderboard-item { display: flex; justify-content: space-between; align-items: center; padding: 1rem; margin-bottom: 0.5rem; background: white; border-radius: 10px; border: 1px solid #e2e8f0; }
    .leaderboard-item:nth-child(1) { background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); }
    .leaderboard-item:nth-child(2) { background: linear-gradient(135deg, #c0c0c0 0%, #e2e8f0 100%); }
    .leaderboard-item:nth-child(3) { background: linear-gradient(135deg, #cd7f32 0%, #d69e2e 100%); }
    .muted { color: #718096; font-size: 0.9rem; font-style: italic; text-align: center; margin: 1rem 0; }
    .debug-info { background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1rem; margin: 1rem 0; font-family: monospace; font-size: 0.9rem; }
    .tabs { display: flex; gap: 1rem; margin-bottom: 1rem; }
    .tab { padding: 0.5rem 1rem; border: none; background: #e2e8f0; color: #4a5568; cursor: pointer; border-radius: 8px; transition: all 0.3s ease; }
    .tab.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .tab:hover:not(.active) { background: #cbd5e0; }
    @media (max-width: 768px) { body { padding: 1rem; } .container { padding: 1rem; } h1 { font-size: 2rem; } .week-controls { grid-template-columns: 1fr; } .picks-grid { grid-template-columns: 1fr; } .user-info { justify-content: center; text-align: center; } }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üèà Weekly Picks</h1>
      <div id="auth"></div>
    </header>

    <div id="main-content" style="display: none;">
      <section class="section">
        <h2>üìã Make Your Picks</h2>
        <div class="week-controls">
          <div>
            <label>Season</label>
            <input id="season" type="number" value="2025" min="2020" max="2030" />
          </div>
          <div>
            <label>Week</label>
            <input id="week" type="number" value="1" min="1" max="18" />
          </div>
        </div>
        <p class="muted">Select your starting lineup for the week. Eligibility is auto-filtered by bye week and your prior picks this season.</p>
        <div id="pick-form" class="picks-grid"></div>
        <div class="submit-section">
          <button id="submit" class="submit-btn">Submit My Picks</button>
          <div id="submit-status"></div>
        </div>
      </section>

      <section class="section">
        <h2>üèÜ Leaderboard</h2>
        <div class="tabs">
          <button id="weekly-tab" class="tab active">Weekly Points</button>
          <button id="season-tab" class="tab">Season Activity</button>
        </div>
        <div id="leaderboard"></div>
        <p id="leaderboard-description" class="muted">Rankings based on total points scored this week.</p>
      </section>
      
      <section class="section">
        <h2>üßÆ My Week Points</h2>
        <div id="my-week"></div>
        <div id="my-week-total" class="muted"></div>
      </section>
    </div>
  </div>

<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

  // TODO: replace with your project values
  const SUPABASE_URL = 'https://zitmhrlmmxxzkwauhbfa.supabase.co'
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InppdG1ocmxtbXh4emt3YXVoYmZhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4NjExMzAsImV4cCI6MjA3MDQzNzEzMH0.grgX_2m3IEuK9Vfj5YvZGRr3dDaYVORT6rWxmoZ_rZ8'
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

  function updateDebugInfo(message) {
    const debugEl = document.getElementById('debug-info')
    if (debugEl) {
      debugEl.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${message}</div>`
      debugEl.scrollTop = debugEl.scrollHeight
    }
    console.log('DEBUG:', message)
  }

  // UI slots (no DB column for slot; we just use these to gather multiple picks)
  const slots = [
    { key: 'QB',  label: 'Quarterback' },
    { key: 'RB1', label: 'Running Back #1' },
    { key: 'RB2', label: 'Running Back #2' },
    { key: 'WR1', label: 'Wide Receiver #1' },
    { key: 'WR2', label: 'Wide Receiver #2' },
    { key: 'TE',  label: 'Tight End' },
    { key: 'FLEX', label: 'Flex (RB/WR/TE)' },
    { key: 'K',   label: 'Kicker' },
    { key: 'DEF', label: 'Defense/ST' }
  ]
  const flexPositions = new Set(['RB','WR','TE'])

  const authEl = document.getElementById('auth')
  const mainContentEl = document.getElementById('main-content')
  const formEl = document.getElementById('pick-form')
  const submitBtn = document.getElementById('submit')
  const submitStatus = document.getElementById('submit-status')
  const seasonEl = document.getElementById('season')
  const weekEl = document.getElementById('week')
  const leaderboardEl = document.getElementById('leaderboard')
  const leaderboardDesc = document.getElementById('leaderboard-description')
  const weeklyTabEl = document.getElementById('weekly-tab')
  const seasonTabEl = document.getElementById('season-tab')

  let currentUser = null
  let teamIndex = new Map()      // id -> abbr
  let eligibleCache = []         // list from RPC for current week
  let currentLeaderboardTab = 'weekly'

  // ---------- Auth ----------
  await initializeApp()

  async function initializeApp() {
    try {
      const { data: { user } } = await supabase.auth.getUser()
      currentUser = user || null

      supabase.auth.onAuthStateChange(async (_evt, session) => {
        currentUser = session?.user || null
        await refreshAuthUI()
      })

      await refreshAuthUI()
    } catch (e) {
      updateDebugInfo(`Initialization error: ${e.message}`)
      authEl.innerHTML = '<div class="status error">Error loading app. Please refresh.</div>'
    }
  }

  async function refreshAuthUI() {
    if (!currentUser) {
      authEl.innerHTML = `
        <div class="auth-section">
          <div class="auth-form">
            <input id="email" type="email" placeholder="Enter your email address" style="min-width: 280px;" />
            <button id="signin" type="button">Send Magic Link</button>
            <p class="muted">We'll send you a secure sign-in link via email</p>
          </div>
        </div>`
      document.getElementById('signin').onclick = async () => {
        const email = document.getElementById('email').value.trim()
        if (!email) return alert('Please enter an email')
        const { error } = await supabase.auth.signInWithOtp({ email, options: { emailRedirectTo: window.location.href } })
        if (error) return alert(error.message)
        alert('Check your email for the sign-in link!')
      }
      mainContentEl.style.display = 'none'
      return
    }

    // user is signed in
    const displayName = await getDisplayName(currentUser.id, currentUser.email)
    authEl.innerHTML = `
      <div class="user-info">
        <span style="font-weight:600;color:#2d3748;">Welcome, ${displayName}! üëã</span>
        <button id="signout" type="button">Sign Out</button>
      </div>`
    document.getElementById('signout').onclick = async () => { await supabase.auth.signOut() }

    mainContentEl.style.display = 'block'

    // prime team index, build form, load leaderboard
    await buildTeamIndex()
    await buildForm()
    await loadMyWeekPoints()
    await loadLeaderboard()
  }

  async function getDisplayName(userId, fallbackEmail) {
    // profiles has: user_id, email, display_name
    const { data, error } = await supabase
      .from('profiles')
      .select('display_name')
      .eq('user_id', userId)
      .maybeSingle()
    if (error) updateDebugInfo(`profiles select error: ${error.message}`)
    return data?.display_name || (fallbackEmail?.split('@')[0] ?? 'Player')
  }

  async function ensureProfile(userId, email) {
    // Trigger should have created it, but create if missing (RLS allows self-insert)
    const { data } = await supabase
      .from('profiles')
      .select('user_id')
      .eq('user_id', userId)
      .maybeSingle()
    if (!data) {
      await supabase.from('profiles').insert({ user_id: userId, email, display_name: email.split('@')[0] })
    }
  }

  // ---------- Data helpers ----------
  async function buildTeamIndex() {
    // cache teams so we can show labels like (KC) in the dropdowns
    const { data, error } = await supabase.from('teams').select('id, abbr')
    if (error) { updateDebugInfo(`teams load error: ${error.message}`); return }
    teamIndex = new Map(data.map(r => [r.id, r.abbr]))
  }

  async function fetchEligible(season, week) {
    const { data, error } = await supabase.rpc('get_eligible_players', {
      _user_id: currentUser.id,
      _season: season,
      _week: week
    })
    if (error) { updateDebugInfo(`eligible RPC error: ${error.message}`); return [] }
    return data // [{player_id, full_name, player_position, team_id}]
  }

  // ---------- Form ----------
  seasonEl.addEventListener('change', async () => { 
    await buildForm()
    await loadMyWeekPoints()
    await loadLeaderboard()
  })
  weekEl.addEventListener('change', async () => { 
    await buildForm()
    await loadMyWeekPoints()
    await loadLeaderboard()
  })

  async function buildForm() {
    formEl.innerHTML = '<div class="status loading">Loading eligible players‚Ä¶</div>'
    const season = Number(seasonEl.value)
    const week = Number(weekEl.value)
    eligibleCache = await fetchEligible(season, week)

    // group eligible by position
    const byPos = new Map()
    for (const p of eligibleCache) {
      const pos = p.player_position
      if (!byPos.has(pos)) byPos.set(pos, [])
      const teamAbbr = teamIndex.get(p.team_id) || 'FA'
      byPos.get(pos).push({ value: String(p.player_id), label: `${p.full_name} (${teamAbbr} ${pos})` })
    }

    // slot ‚Üí options (DEF pulls from DEF eligible if present, FLEX from RB/WR/TE)
    const slotEls = []
    for (const slot of slots) {
      const pos = slot.key === 'FLEX' ? 'FLEX' : (slot.key === 'DEF' ? 'DEF' : slot.key.replace(/\d/, ''))
      const select = document.createElement('select')
      select.id = `slot-${slot.key}`
      select.required = true

      const defOpt = document.createElement('option')
      defOpt.value = ''
      defOpt.textContent = `-- Select ${slot.label} --`
      select.appendChild(defOpt)

      let options = []
      if (pos === 'FLEX') {
        options = [ ...(byPos.get('RB')||[]), ...(byPos.get('WR')||[]), ...(byPos.get('TE')||[]) ]
      } else {
        options = byPos.get(pos) || []
      }
      // sort labels for UX
      options.sort((a,b) => a.label.localeCompare(b.label))
      for (const opt of options) {
        const o = document.createElement('option')
        o.value = opt.value
        o.textContent = opt.label
        select.appendChild(o)
      }

      const slotDiv = document.createElement('div')
      slotDiv.className = 'pick-slot'
      slotDiv.innerHTML = `<label class="position-label">${slot.label}</label>`
      slotDiv.appendChild(select)
      slotEls.push(slotDiv)
    }

    formEl.innerHTML = ''
    slotEls.forEach(el => formEl.appendChild(el))
  }

  // ---------- Submit picks ----------
  submitBtn.onclick = async () => {
    if (!currentUser) return alert('Please sign in first')

    const season = Number(seasonEl.value)
    const week = Number(weekEl.value)

    submitBtn.disabled = true
    submitStatus.innerHTML = '<div class="status loading">Submitting your picks‚Ä¶</div>'

    try {
      await ensureProfile(currentUser.id, currentUser.email)

      // Build selected player_ids (dedupe; FLEX can repeat across positions but not same player twice)
      const selected = []
      const used = new Set()
      for (const { key, label } of slots) {
        const val = document.getElementById(`slot-${key}`).value
        if (!val) throw new Error(`Please select ${label}`)
        if (used.has(val)) throw new Error(`Duplicate player selected: ${label}`)
        used.add(val)
        selected.push(Number(val))
      }

      // Optional: clear previous week picks for this user (if you want one lineup per week)
      // await supabase.from('picks').delete().eq('user_id', currentUser.id).eq('season', season).eq('week', week)

      // Call make_pick for each selected player_id
      for (const pid of selected) {
        const { data, error } = await supabase.rpc('make_pick', {
          _user_id: currentUser.id,
          _season: season,
          _week: week,
          _player_id: pid
        })
        if (error) throw error
        updateDebugInfo(`make_pick -> ${data}`)
      }

      submitStatus.innerHTML = '<div class="status success">‚úÖ Picks submitted successfully!</div>'
      await loadMyWeekPoints()
      await loadLeaderboard()
    } catch (e) {
      console.error(e)
      submitStatus.innerHTML = `<div class="status error">‚ùå ${e.message}</div>`
    } finally {
      submitBtn.disabled = false
    }
  }

  // ---------- My Week Points ----------
  async function loadMyWeekPoints() {
    const season = Number(seasonEl.value)
    const week = Number(weekEl.value)
    if (!currentUser) return

    const container = document.getElementById('my-week')
    const totalEl = document.getElementById('my-week-total')
    container.innerHTML = '<div class="status loading">Loading your points‚Ä¶</div>'
    totalEl.textContent = ''

    const { data, error } = await supabase.rpc('get_user_week_points', {
      _user_id: currentUser.id,
      _season: season,
      _week: week
    })

    if (error) {
      container.innerHTML = '<div class="status error">Could not load your points.</div>'
      totalEl.textContent = ''
      updateDebugInfo(`get_user_week_points error: ${error.message}`)
      return
    }

    if (!data || data.length === 0) {
      container.innerHTML = '<p class="muted">No picks submitted for this week yet.</p>'
      totalEl.textContent = ''
      return
    }

    let html = '<div class="leaderboard-list">'
    let total = 0
    data.forEach(row => {
      const team = row.team_abbr || 'FA'
      const pts = Number(row.points ?? 0)
      total += pts
      html += `<div class="leaderboard-item"><span>${row.full_name} (${team} ${row.player_position})</span><span><strong>${pts.toFixed(2)} pts</strong></span></div>`
    })
    html += '</div>'

    container.innerHTML = html
    totalEl.textContent = `Week ${week} total: ${total.toFixed(2)} pts`
  }

  // ---------- Leaderboard Tabs ----------
  weeklyTabEl.onclick = () => {
    currentLeaderboardTab = 'weekly'
    weeklyTabEl.classList.add('active')
    seasonTabEl.classList.remove('active')
    loadLeaderboard()
  }

  seasonTabEl.onclick = () => {
    currentLeaderboardTab = 'season'
    seasonTabEl.classList.add('active')
    weeklyTabEl.classList.remove('active')
    loadLeaderboard()
  }

  // ---------- Leaderboard ----------
  async function loadLeaderboard() {
    const season = Number(seasonEl.value)
    const week = Number(weekEl.value)
    
    leaderboardEl.innerHTML = '<div class="status loading">Loading leaderboard‚Ä¶</div>'

    if (currentLeaderboardTab === 'weekly') {
      await loadWeeklyLeaderboard(season, week)
    } else {
      await loadSeasonLeaderboard(season)
    }
  }

  async function loadWeeklyLeaderboard(season, week) {
    const { data, error } = await supabase.rpc('get_weekly_leaderboard', { _season: season, _week: week })
    
    if (error) { 
      leaderboardEl.innerHTML = '<p class="muted">Could not load weekly leaderboard.</p>'
      updateDebugInfo(`get_weekly_leaderboard error: ${error.message}`)
      return 
    }
    
    if (!data || data.length === 0) { 
      leaderboardEl.innerHTML = '<p class="muted">No scores yet for this week.</p>'
      return 
    }

    leaderboardDesc.textContent = `Rankings based on total points scored for week ${week}.`
    leaderboardEl.innerHTML = '<div class="leaderboard-list"></div>'
    const list = leaderboardEl.querySelector('.leaderboard-list')
    
    data.forEach((row, i) => {
      const medal = ['ü•á','ü•à','ü•â'][i] ?? `${i+1}.`
      const div = document.createElement('div')
      div.className = 'leaderboard-item'
      div.innerHTML = `<span>${medal} ${row.display_name}</span><span><strong>${Number(row.total_points).toFixed(2)} pts</strong></span>`
      list.appendChild(div)
    })
  }

  async function loadSeasonLeaderboard(season) {
    const { data, error } = await supabase
      .from('picks')
      .select('user_id')
      .eq('season', season)
      
    if (error) { 
      leaderboardEl.innerHTML = '<p class="muted">Could not load season activity.</p>'
      updateDebugInfo(`season picks query error: ${error.message}`)
      return 
    }

    const counts = new Map()
    for (const r of data) {
      counts.set(r.user_id, (counts.get(r.user_id) || 0) + 1)
    }
    
    const items = [...counts.entries()].sort((a, b) => b[1] - a[1])

    if (items.length === 0) {
      leaderboardEl.innerHTML = '<p class="muted">No picks submitted yet for this season.</p>'
      return
    }

    leaderboardDesc.textContent = 'Rankings based on total picks submitted this season.'
    leaderboardEl.innerHTML = '<div class="leaderboard-list"></div>'
    const list = leaderboardEl.querySelector('.leaderboard-list')

    // Get display names for users
    const userIds = items.map(([userId]) => userId)
    const { data: profiles } = await supabase
      .from('profiles')
      .select('user_id, display_name')
      .in('user_id', userIds)
    
    const displayNames = new Map(profiles?.map(p => [p.user_id, p.display_name]) || [])

    let rank = 1
    for (const [userId, count] of items) {
      const displayName = displayNames.get(userId) || userId.slice(0, 8) + '‚Ä¶'
      const medal = rank <= 3 ? ['ü•á','ü•à','ü•â'][rank - 1] : `${rank}.`
      const row = document.createElement('div')
      row.className = 'leaderboard-item'
      row.innerHTML = `<span>${medal} ${displayName}</span><span><strong>${count} picks</strong></span>`
      list.appendChild(row)
      rank++
    }
  }
</script>
</body>
</html>


