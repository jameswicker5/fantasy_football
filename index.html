<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>NFL Weekly Picks</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: system-ui, sans-serif; 
      margin: 0; 
      padding: 2rem; 
      max-width: 1200px; 
      margin: 0 auto;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    
    .container {
      background: white;
      border-radius: 20px;
      padding: 2rem;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    }
    
    header { 
      text-align: center;
      margin-bottom: 2rem; 
      border-bottom: 2px solid #f0f0f0;
      padding-bottom: 1rem;
    }
    
    h1 { 
      color: #2d3748; 
      font-size: 2.5rem; 
      margin: 0;
      background: linear-gradient(45deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .section { 
      margin-bottom: 2rem; 
      background: #f8fafc;
      border-radius: 15px;
      padding: 1.5rem;
    }
    
    .auth-section {
      text-align: center;
      background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
    }
    
    .auth-form {
      display: inline-flex;
      flex-direction: column;
      gap: 1rem;
      align-items: center;
    }
    
    .user-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    label { 
      display: block; 
      margin-bottom: 0.5rem; 
      font-weight: 600;
      color: #2d3748;
    }
    
    select, input, button { 
      padding: 0.75rem; 
      margin: 0.25rem 0; 
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 1rem;
      transition: all 0.3s ease;
    }
    
    select:focus, input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: transform 0.2s ease;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }
    
    button:disabled {
      background: #cbd5e0;
      cursor: not-allowed;
      transform: none;
    }
    
    .week-controls { 
      display: grid; 
      grid-template-columns: 1fr 1fr; 
      gap: 1rem; 
      margin-bottom: 1.5rem;
    }
    
    .picks-grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
      gap: 1rem; 
      margin-bottom: 1.5rem;
    }
    
    .pick-slot {
      background: white;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 1rem;
      transition: all 0.3s ease;
    }
    
    .pick-slot:hover {
      border-color: #667eea;
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.1);
    }
    
    .pick-slot select {
      width: 100%;
      margin: 0;
    }
    
    .position-label {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
    }
    
    .submit-section {
      text-align: center;
    }
    
    .submit-btn {
      padding: 1rem 2rem;
      font-size: 1.1rem;
      min-width: 200px;
    }
    
    .status {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 10px;
      font-weight: 600;
    }
    
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .status.loading {
      background: #cce7ff;
      color: #004085;
      border: 1px solid #b3d7ff;
    }
    
    .leaderboard-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .leaderboard-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      margin-bottom: 0.5rem;
      background: white;
      border-radius: 10px;
      border: 1px solid #e2e8f0;
    }
    
    .leaderboard-item:nth-child(1) { background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); }
    .leaderboard-item:nth-child(2) { background: linear-gradient(135deg, #c0c0c0 0%, #e2e8f0 100%); }
    .leaderboard-item:nth-child(3) { background: linear-gradient(135deg, #cd7f32 0%, #d69e2e 100%); }
    
    .muted { 
      color: #718096; 
      font-size: 0.9rem; 
      font-style: italic;
      text-align: center;
      margin: 1rem 0;
    }
    
    .debug-info {
      background: #f7fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 1rem;
      margin: 1rem 0;
      font-family: monospace;
      font-size: 0.9rem;
    }
    
    @media (max-width: 768px) {
      body { padding: 1rem; }
      .container { padding: 1rem; }
      h1 { font-size: 2rem; }
      .week-controls { grid-template-columns: 1fr; }
      .picks-grid { grid-template-columns: 1fr; }
      .user-info { justify-content: center; text-align: center; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üèà NFL Weekly Picks</h1>
      <div id="auth"></div>
    </header>

    <div id="main-content" style="display: none;">
      <section class="section">
        <h2>üìã Make Your Picks</h2>
        <div class="week-controls">
          <div>
            <label>Season</label>
            <input id="season" type="number" value="2025" min="2020" max="2030" />
          </div>
          <div>
            <label>Week</label>
            <input id="week" type="number" value="1" min="1" max="18" />
          </div>
        </div>

        <p class="muted">Select your starting lineup for the week. Each position must be filled!</p>

        <div id="pick-form" class="picks-grid">
          <!-- Pick slots will be generated here -->
        </div>
        
        <div class="submit-section">
          <button id="submit" class="submit-btn">Submit My Picks</button>
          <div id="submit-status"></div>
        </div>
      </section>

      <section class="section">
        <h2>üèÜ Leaderboard</h2>
        <div id="leaderboard"></div>
        <p class="muted">Rankings based on total picks submitted this season.</p>
      </section>
      
      <!-- Debug section -->
      <section class="section">
        <h2>üîß Debug Info</h2>
        <div id="debug-info" class="debug-info">
          Debug information will appear here...
        </div>
      </section>
    </div>
  </div>

<script type="module">
  // Import Supabase
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
const SUPABASE_URL = 'https://zitmhrlmmxxzkwauhbfa.supabase.co'
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InppdG1ocmxtbXh4emt3YXVoYmZhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4NjExMzAsImV4cCI6MjA3MDQzNzEzMH0.grgX_2m3IEuK9Vfj5YvZGRr3dDaYVORT6rWxmoZ_rZ8'

  // Initialize Supabase client
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

// Debug function
function updateDebugInfo(message) {
  const debugEl = document.getElementById('debug-info')
  if (debugEl) {
    debugEl.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${message}</div>`
    debugEl.scrollTop = debugEl.scrollHeight
  }
  console.log('DEBUG:', message)
}

const slots = [
  { key: 'QB', label: 'Quarterback', count: 1 },
  { key: 'RB1', label: 'Running Back #1', count: 1 },
  { key: 'RB2', label: 'Running Back #2', count: 1 },
  { key: 'WR1', label: 'Wide Receiver #1', count: 1 },
  { key: 'WR2', label: 'Wide Receiver #2', count: 1 },
  { key: 'TE', label: 'Tight End', count: 1 },
  { key: 'FLEX', label: 'Flex (RB/WR/TE)', count: 1 },
  { key: 'K', label: 'Kicker', count: 1 },
  { key: 'DEF', label: 'Defense/ST', count: 1 }
]

const flexPositions = new Set(['RB', 'WR', 'TE'])

const authEl = document.getElementById('auth')
const mainContentEl = document.getElementById('main-content')
const formEl = document.getElementById('pick-form')
const submitBtn = document.getElementById('submit')
const submitStatus = document.getElementById('submit-status')
const seasonEl = document.getElementById('season')
const weekEl = document.getElementById('week')
const leaderboardEl = document.getElementById('leaderboard')

let currentUser = null
let playersCache = {}

// Initialize the app
await initializeApp()

async function initializeApp() {
  try {
    updateDebugInfo('Initializing app...')
    
    // Handle URL hash for authentication (magic link redirect)
    if (window.location.hash) {
      const hashParams = new URLSearchParams(window.location.hash.substr(1))
      if (hashParams.get('type') === 'email') {
        authEl.innerHTML = '<div class="status loading">Completing sign-in...</div>'
        updateDebugInfo('Processing magic link authentication')
        
        // Let Supabase handle the auth
        const { data, error } = await supabase.auth.getSession()
        
        if (error) {
          console.error('Auth error:', error)
          updateDebugInfo(`Auth error: ${error.message}`)
          authEl.innerHTML = `<div class="status error">Sign-in error: ${error.message}</div>`
          // Clear the hash and reload
          setTimeout(() => {
            window.location.hash = ''
            window.location.reload()
          }, 3000)
        } else if (data.session) {
          updateDebugInfo('Authentication successful')
          // Clear the hash
          window.history.replaceState(null, null, window.location.pathname)
          currentUser = data.session.user
        }
      }
    }
    
    await refreshAuthUI()
  } catch (error) {
    console.error('Initialization error:', error)
    updateDebugInfo(`Initialization error: ${error.message}`)
    authEl.innerHTML = '<div class="status error">Error loading app. Please refresh the page.</div>'
  }
}

// Helper to get user handle
async function getHandle(userId) {
  try {
    const { data, error } = await supabase
      .from('profiles')
      .select('handle')
      .eq('user_id', userId)
      .maybeSingle()
    
    if (error) {
      updateDebugInfo(`Error fetching handle for user ${userId}: ${error.message}`)
      console.error('Error fetching handle:', error)
    }
    return data?.handle || 'Anonymous Player'
  } catch (error) {
    console.error('Error in getHandle:', error)
    updateDebugInfo(`Exception in getHandle: ${error.message}`)
    return 'Anonymous Player'
  }
}

// Listen for auth state changes
supabase.auth.onAuthStateChange(async (event, session) => {
  console.log('Auth state changed:', event, session?.user?.email)
  updateDebugInfo(`Auth state changed: ${event} - ${session?.user?.email || 'no user'}`)
  
  if (event === 'SIGNED_IN') {
    currentUser = session?.user || null
    await refreshAuthUI()
  } else if (event === 'SIGNED_OUT') {
    currentUser = null
    await refreshAuthUI()
  }
})

// Auth UI Management
async function refreshAuthUI() {
  try {
    // Get current session if we don't have currentUser set
    if (!currentUser) {
      const { data } = await supabase.auth.getUser()
      currentUser = data.user
    }
    
    if (!currentUser) {
      updateDebugInfo('No authenticated user, showing login form')
      authEl.innerHTML = `
        <div class="auth-section">
          <div class="auth-form">
            <input id="email" type="email" placeholder="Enter your email address" style="min-width: 280px;" />
            <button id="signin" type="button">Send Magic Link</button>
            <p class="muted">We'll send you a secure sign-in link via email</p>
          </div>
        </div>
      `
      
      document.getElementById('signin').onclick = async () => {
        const email = document.getElementById('email').value.trim()
        if (!email) {
          alert('Please enter an email address')
          return
        }
        
        const button = document.getElementById('signin')
        button.disabled = true
        button.textContent = 'Sending...'
        updateDebugInfo(`Sending magic link to: ${email}`)
        
        try {
          // Get the current URL without any hash
          const redirectUrl = window.location.origin + window.location.pathname
          
          const { error } = await supabase.auth.signInWithOtp({ 
            email,
            options: {
              emailRedirectTo: redirectUrl
            }
          })
          
          if (error) {
            throw error
          }
          
          alert('Check your email for the sign-in link!')
          button.textContent = 'Link Sent!'
          updateDebugInfo(`Magic link sent successfully to ${email}`)
          
        } catch (error) {
          alert('Error: ' + error.message)
          updateDebugInfo(`Error sending magic link: ${error.message}`)
          button.disabled = false
          button.textContent = 'Send Magic Link'
        }
      }
      
      mainContentEl.style.display = 'none'
    } else {
      updateDebugInfo(`User authenticated: ${currentUser.email} (ID: ${currentUser.id})`)
      const handle = await getHandle(currentUser.id)
      authEl.innerHTML = `
        <div class="user-info">
          <span style="font-weight: 600; color: #2d3748;">
            Welcome, ${handle}! üëã
          </span>
          <button id="signout" type="button">Sign Out</button>
        </div>
      `
      
      document.getElementById('signout').onclick = async () => {
        updateDebugInfo('User signing out')
        await supabase.auth.signOut()
      }
      
      mainContentEl.style.display = 'block'
      await buildForm()
      await loadLeaderboard()
    }
  } catch (error) {
    console.error('Error in refreshAuthUI:', error)
    updateDebugInfo(`Error in refreshAuthUI: ${error.message}`)
    authEl.innerHTML = '<p class="error">Error loading authentication. Please refresh the page.</p>'
  }
}

// Test database connection
async function testDatabaseConnection() {
  updateDebugInfo('Testing database connections...')
  
  try {
    // Test players table
    const { data: playersTest, error: playersError } = await supabase
      .from('players')
      .select('gsis_id, display_name, team, position')
      .limit(5)
    
    if (playersError) {
      updateDebugInfo(`Players table error: ${playersError.message}`)
    } else {
      updateDebugInfo(`Players table OK - found ${playersTest.length} sample records`)
    }
    
    // Test defenses table
    const { data: defensesTest, error: defensesError } = await supabase
      .from('defenses')
      .select('def_id, display_name, team')
      .limit(5)
    
    if (defensesError) {
      updateDebugInfo(`Defenses table error: ${defensesError.message}`)
    } else {
      updateDebugInfo(`Defenses table OK - found ${defensesTest.length} sample records`)
    }
    
    // Test profiles table
    const { data: profilesTest, error: profilesError } = await supabase
      .from('profiles')
      .select('user_id')
      .limit(1)
    
    if (profilesError) {
      updateDebugInfo(`Profiles table error: ${profilesError.message}`)
    } else {
      updateDebugInfo(`Profiles table OK`)
    }
    
  } catch (error) {
    updateDebugInfo(`Database test exception: ${error.message}`)
  }
}

// Load players by position
async function loadPlayersByPosition(position) {
  try {
    updateDebugInfo(`Loading players for position: ${position}`)
    
    if (playersCache[position]) {
      updateDebugInfo(`Using cached data for ${position} (${playersCache[position].length} players)`)
      return playersCache[position]
    }
    
    if (position === 'DEF') {
      const { data, error } = await supabase
        .from('defenses')
        .select('def_id, display_name, team')
        .order('def_id')
      
      if (error) {
        updateDebugInfo(`Error loading defenses: ${error.message}`)
        throw error
      }
      
      const players = data.map(d => ({
        id: d.def_id,
        label: d.display_name,
        pos: 'DEF'
      }))
      
      playersCache[position] = players
      updateDebugInfo(`Loaded ${players.length} defenses`)
      return players
    }
    
    if (position === 'FLEX') {
      const { data, error } = await supabase
        .from('players')
        .select('gsis_id, display_name, team, position')
        .in('position', ['RB', 'WR', 'TE'])
        .order('position')
        .order('team')
        .order('display_name')
      
      if (error) {
        updateDebugInfo(`Error loading FLEX players: ${error.message}`)
        throw error
      }
      
      const players = data.map(p => ({
        id: p.gsis_id,
        label: `${p.display_name} (${p.team} ${p.position})`,
        pos: p.position
      }))
      
      playersCache[position] = players
      updateDebugInfo(`Loaded ${players.length} FLEX players`)
      return players
    }
    
    // Regular position
    const { data, error } = await supabase
      .from('players')
      .select('gsis_id, display_name, team, position')
      .eq('position', position)
      .order('team')
      .order('display_name')
    
    if (error) {
      updateDebugInfo(`Error loading ${position} players: ${error.message}`)
      throw error
    }
    
    const players = data.map(p => ({
      id: p.gsis_id,
      label: `${p.display_name} (${p.team})`,
      pos: p.position
    }))
    
    playersCache[position] = players
    updateDebugInfo(`Loaded ${players.length} ${position} players`)
    return players
  } catch (error) {
    console.error(`Error loading players for position ${position}:`, error)
    updateDebugInfo(`Exception loading ${position}: ${error.message}`)
    return []
  }
}

// Build the pick form
async function buildForm() {
  try {
    updateDebugInfo('Building pick form...')
    formEl.innerHTML = '<div class="loading">Loading players...</div>'
    
    // Test database connection first
    await testDatabaseConnection()
    
    const slotElements = []
    
    for (const slot of slots) {
      const position = slot.key === 'DEF' ? 'DEF' : 
                     slot.key === 'FLEX' ? 'FLEX' : 
                     slot.key.replace(/\d/, '')
      
      updateDebugInfo(`Building form for slot: ${slot.key} (position: ${position})`)
      const players = await loadPlayersByPosition(position)
      
      if (players.length === 0) {
        updateDebugInfo(`WARNING: No players found for position ${position}`)
      }
      
      const select = document.createElement('select')
      select.id = `slot-${slot.key}`
      select.required = true
      
      // Add default option
      const defaultOption = document.createElement('option')
      defaultOption.value = ''
      defaultOption.textContent = `-- Select ${slot.label} --`
      select.appendChild(defaultOption)
      
      // Add player options
      players.forEach(player => {
        const option = document.createElement('option')
        option.value = player.id
        option.textContent = player.label
        select.appendChild(option)
      })
      
      const slotDiv = document.createElement('div')
      slotDiv.className = 'pick-slot'
      slotDiv.innerHTML = `
        <label class="position-label">${slot.label}</label>
      `
      slotDiv.appendChild(select)
      
      slotElements.push(slotDiv)
    }
    
    formEl.innerHTML = ''
    slotElements.forEach(el => formEl.appendChild(el))
    updateDebugInfo('Pick form built successfully')
    
  } catch (error) {
    console.error('Error building form:', error)
    updateDebugInfo(`Error building form: ${error.message}`)
    formEl.innerHTML = '<div class="error">Error loading form. Please refresh the page.</div>'
  }
}

// Submit picks
async function ensureProfile(userId) {
  try {
    updateDebugInfo(`Ensuring profile exists for user: ${userId}`)
    
    const { data: existingProfile, error: selectError } = await supabase
      .from('profiles')
      .select('user_id')
      .eq('user_id', userId)
      .maybeSingle()
    
    if (selectError) {
      updateDebugInfo(`Error checking existing profile: ${selectError.message}`)
      console.warn('profiles select error:', selectError)
    }
    
    if (!existingProfile) {
      updateDebugInfo('Profile does not exist, creating new profile')
      const { error: insertError } = await supabase
        .from('profiles')
        .insert({ 
          user_id: userId,
          handle: `Player${userId.slice(-4)}` // Generate a default handle
        })
      
      if (insertError) {
        updateDebugInfo(`Error creating profile: ${insertError.message}`)
        console.warn('profiles insert error:', insertError)
      } else {
        updateDebugInfo('Profile created successfully')
      }
    } else {
      updateDebugInfo('Profile already exists')
    }
  } catch (error) {
    updateDebugInfo(`Exception in ensureProfile: ${error.message}`)
    console.error('Exception in ensureProfile:', error)
  }
}

submitBtn.onclick = async () => {
  if (!currentUser) { 
    alert('Please sign in first'); 
    return 
  }

  try {
    submitBtn.disabled = true
    submitStatus.innerHTML = '<div class="status loading">Submitting your picks...</div>'
    updateDebugInfo('=== STARTING PICK SUBMISSION ===')

    const season = Number(seasonEl.value)
    const week = Number(weekEl.value)
    if (!season || !week) {
      throw new Error('Please enter valid season and week')
    }
    
    updateDebugInfo(`Submitting picks for Season ${season}, Week ${week}`)
    updateDebugInfo(`User: ${currentUser.email} (ID: ${currentUser.id})`)

    // First, delete any existing picks for this user/season/week
    updateDebugInfo('Checking for existing picks to delete...')
    const { data: existingPicks, error: deleteError } = await supabase
      .from('picks')
      .delete()
      .eq('user_id', currentUser.id)
      .eq('season', season)
      .eq('week', week)
      .select()
    
    if (deleteError) {
      updateDebugInfo(`Error deleting existing picks: ${deleteError.message}`)
    } else {
      updateDebugInfo(`Deleted ${existingPicks?.length || 0} existing picks`)
    }

    const picks = []
    const used = new Set()
    
    for (const { key, label } of slots) {
      const element = document.getElementById(`slot-${key}`)
      const val = (element?.value || '').trim()
      
      updateDebugInfo(`Processing slot ${key} (${label}): value="${val}"`)
      
      if (!val) {
        throw new Error(`Please select ${label}`)
      }
      
      // Enhanced duplicate check (only for non-FLEX positions)
      if (key !== 'FLEX') {
        if (used.has(val)) {
          throw new Error(`Duplicate player selected: ${label}`)
        }
        used.add(val)
      }
      
      // Create the pick object based on the database schema
      const pick = {
        user_id: currentUser.id,
        season: season,
        week: week,
        slot: key
      }
      
      // Set either gsis_id or def_id based on position
      if (key === 'DEF') {
        pick.def_id = val
        pick.gsis_id = null
      } else {
        pick.gsis_id = val
        pick.def_id = null
      }
      
      picks.push(pick)
      updateDebugInfo(`Added pick: ${JSON.stringify(pick)}`)
    }

    updateDebugInfo(`Total picks to submit: ${picks.length}`)

    // Ensure profile exists
    await ensureProfile(currentUser.id)

    // Submit the picks
    updateDebugInfo('Submitting picks to database...')
    const { data: insertedPicks, error: insertError } = await supabase
      .from('picks')
      .insert(picks)
      .select()

    if (insertError) {
      updateDebugInfo(`Detailed picks insert error: ${JSON.stringify({
        message: insertError.message,
        details: insertError.details,
        code: insertError.code,
        hint: insertError.hint
      })}`)
      
      console.error('Detailed picks insert error:', insertError)
      submitStatus.innerHTML = `<div class="status error">‚ùå ${insertError.message} ${insertError.details || ''}</div>`
      return
    }

    updateDebugInfo(`Successfully inserted ${insertedPicks?.length || 0} picks`)
    updateDebugInfo('=== PICK SUBMISSION COMPLETE ===')
    
    submitStatus.innerHTML = '<div class="status success">‚úÖ Picks submitted successfully!</div>'
    await loadLeaderboard()
    
  } catch (e) {
    console.error('Comprehensive submit error:', e)
    updateDebugInfo(`ERROR in submission: ${e.message}`)
    submitStatus.innerHTML = `<div class="status error">‚ùå ${e.message}</div>`
  } finally {
    submitBtn.disabled = false
  }
}

// Load leaderboard
async function loadLeaderboard() {
  try {
    updateDebugInfo('Loading leaderboard...')
    const season = Number(seasonEl.value)
    
    const { data, error } = await supabase
      .from('picks')
      .select('user_id, season')
      .eq('season', season)
    
    if (error) {
      updateDebugInfo(`Error loading leaderboard: ${error.message}`)
      throw error
    }
    
    updateDebugInfo(`Found ${data.length} total picks for season ${season}`)
    
    // Count picks per user
    const userCounts = {}
    data.forEach(pick => {
      userCounts[pick.user_id] = (userCounts[pick.user_id] || 0) + 1
    })
    
    // Sort by pick count
    const sortedUsers = Object.entries(userCounts)
      .sort(([,a], [,b]) => b - a)
    
    updateDebugInfo(`Leaderboard has ${sortedUsers.length} users`)
    
    if (sortedUsers.length === 0) {
      leaderboardEl.innerHTML = '<p class="muted">No picks submitted yet for this season.</p>'
      return
    }
    
    // Get handles for users
    const leaderboardItems = await Promise.all(
      sortedUsers.map(async ([userId, count], index) => {
        const handle = await getHandle(userId)
        const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}.`
        
        return `
          <div class="leaderboard-item">
            <span>${medal} ${handle}</span>
            <span><strong>${count} picks</strong></span>
          </div>
        `
      })
    )
    
    leaderboardEl.innerHTML = `<div class="leaderboard-list">${leaderboardItems.join('')}</div>`
    updateDebugInfo('Leaderboard loaded successfully')
    
  } catch (error) {
    console.error('Error loading leaderboard:', error)
    updateDebugInfo(`Error loading leaderboard: ${error.message}`)
    leaderboardEl.innerHTML = '<p class="error">Error loading leaderboard</p>'
  }
}

// Season/Week change handlers
seasonEl.addEventListener('change', () => {
  updateDebugInfo(`Season changed to: ${seasonEl.value}`)
  loadLeaderboard()
})

weekEl.addEventListener('change', () => {
  updateDebugInfo(`Week changed to: ${weekEl.value}`)
  // Could load existing picks for the week here
})

</script>
</body>
</html>

